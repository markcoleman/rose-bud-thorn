name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test-spm:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Cache SPM dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.swiftpm
          .build
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    - name: Build with Swift Package Manager
      run: |
        swift build --configuration release

    - name: Test with Swift Package Manager
      run: |
        swift test --configuration release

  build-and-test-xcode:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Cache SPM & DerivedData
      uses: actions/cache@v4
      with:
        path: |
          ~/.swiftpm
          .build
          DerivedData
        key: ${{ runner.os }}-cache-${{ hashFiles('**/Package.resolved','**/*.xcodeproj/***','**/*.xcworkspace/***') }}
        restore-keys: |
          ${{ runner.os }}-cache-

    - name: Install xcpretty
      run: gem install xcpretty

    - name: Build with Xcode
      run: |
        set -o pipefail && \
        xcodebuild \
          -scheme RoseBudThornApp \
          -sdk iphonesimulator \
          -destination 'platform=iOS Simulator,name=iPhone 13,OS=latest' \
          -derivedDataPath DerivedData \
          clean build CODE_SIGNING_ALLOWED=NO \
        | xcpretty
        